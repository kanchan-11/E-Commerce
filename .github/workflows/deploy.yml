name: Deploy to Production Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: learningweb
  CONTAINER_NAME: learningweb-app

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE }}:latest .
        docker save ${{ env.DOCKER_IMAGE }}:latest | gzip > learningweb-image.tar.gz

    - name: Copy files to server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "learningweb-image.tar.gz"
        target: "/tmp/"

    - name: Deploy on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # Load the Docker image
          docker load < /tmp/learningweb-image.tar.gz
          
          # Stop and remove existing container
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          
          # Run new container
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            -p 80:8080 \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -e "ConnectionStrings__DefaultConnection=${{ secrets.CONNECTION_STRING }}" \
            -e "Stripe__SecretKey=${{ secrets.STRIPE_SECRET_KEY }}" \
            -e "Stripe__PublishableKey=${{ secrets.STRIPE_PUBLISHABLE_KEY }}" \
            -e "SendGrid__SecretKey=${{ secrets.SENDGRID_SECRET_KEY }}" \
            --restart unless-stopped \
            -v learningweb-images:/app/wwwroot/images/product \
            ${{ env.DOCKER_IMAGE }}:latest
          
          # Clean up
          rm /tmp/learningweb-image.tar.gz
          docker image prune -f
          
          # Wait and check if container is running
          sleep 5
          docker ps --filter name=${{ env.CONTAINER_NAME }}

    - name: Verify deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          # Check container health
          if docker ps --filter name=${{ env.CONTAINER_NAME }} --filter status=running | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "? Deployment successful!"
            docker logs --tail 50 ${{ env.CONTAINER_NAME }}
          else
            echo "? Deployment failed!"
            docker logs --tail 100 ${{ env.CONTAINER_NAME }}
            exit 1
          fi
